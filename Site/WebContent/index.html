<!DOCTYPE html>
<html>
<head>
    <title>Race to the Bottom</title>
    <link rel="stylesheet" type="text/css" href="game.css">

    <!--1 Libraries-->
    <script src="sockjs-0.3.4.js"></script>
    <script src="stomp.js"></script>
    <script src="jquery-2.1.1.min.js"></script>
    <!--2 Utilities-->
    <script type="text/javascript" src="stompService.js"></script>
    <!--3 Main Classes-->
    <script type="text/javascript" src="userProxy.js"></script>
    <script src="gameProxy.js"></script>


</head>
<body>
<noscript><h2 style="color: #ff0000">Seems your browser doesn't support Javascript! Websocket relies on Javascript being enabled. Please enable
    Javascript and reload this page!</h2></noscript>
<div id="mainContentWrapper" style="text-align:center">
    <button id="logoutButton" style="position:fixed;top:0;left:0;display:none;">Log Out</button>
    <div class="loginHide" style="display:none;"><span>&nbsp;</span></div>
    <div id="loginWrapper">
        <div id="loginTop" style="border: 1px solid black;background-color:cornflowerblue;">
            <form id="loginUserForm" >
                <h2>Login</h2>
                <label for="userEmailLogin">Email</label>
                <input id="userEmailLogin" name="email" type="text"   placeholder="email" />
                <label for="userPassLogin">Password</label>
                <input id="userPassLogin" name="password" type="password" placeholder="password" />

            </form>
            <div>
                <button id="loginSubmitButton" style="width: 100px;height: 30px;font-size: 15px;">Login</button>
            </div>
        </div>
        <div id="loginBottom">
            <button id="registerAsNewPlayerButton">Register as a new Player</button>

        </div>
    </div>


    <div id="registerWrapper" style="border: 1px solid black;display:none;background-color:cornsilk;">
        <button id="backToLoginButton">Back to Login Screen</button>
        <form id="registerUserForm" >
            <h2>Register User</h2>
            <label for="userEmail">Email</label>
            <input id="userEmail" name="email" type="text"   placeholder="email" />
            <label for="userPass">Password</label>
            <input id="userPass" name="password" type="password" placeholder="password" />
            <label for="userName">NickName</label>
            <input id="userName" name="name" type="text" placeholder="NickName" />
        </form>
        <button id="registerUserSubmitButton">Send Info</button>
    </div>




    <div id="lobbyWrapper" style="display:none;background-color:grey;border:1px solid black;">
        <div id="gamesInProgressWrapper">
        <h2>Games In Progress</h2>
        <table id="gamesInProgressTable" style="width:100%;background-color:white;border:1px solid black;">
        </table>
        </div>

        <div id="startAGameWrapper">
            <div id="startGamePanel" style="border: 1px solid black;background-color:indianred;">
                <div class="lobbyPanelContent">
                    <h2>Start a Game</h2>
                    <div>
                        <button>VS AI</button>
                    </div>
                    <div>
                        <button id="startGameButton">Invite a Player &gt;</button><input style="width:150px" id="emailToNotifyInput" name="emailToNotify" type="text" placeholder="Player email">
                    </div>
                    <div>
                        <button id="startGameNewPlayerButton">Invite a new Player &gt;</button><input id="newEmailToNotifyInput" name="newEmailToNotify" type="text" placeholder="New player email">
                    </div>

                </div>

            </div>
        </div>
        <div id="leaderBoardWrapper">
            <h2>LeaderBoard</h2>
            <table style="width:100%;background-color:white;border:1px solid black;">
                <tr><td>1</td></tr>
                <tr><td>2</td></tr>
                <tr><td>3</td></tr>
            </table>
        </div>


    </div>



    <div id="gameStageWrapper" style="display:none;">
        <button id="backToLobbyButton">Back to Lobby</button>
        <div id="gameStageMain">
            <div id="waitingScreen">Waiting For Next Turn</div>
            <div id="districtStage" >
                <!--Districts generated here-->
            </div>
            <div id="bottomStage">
                <div id="cardStage">
                    <!--Cards generated here-->
                </div>
                <div id="widgetWrapper" style="width:70px">
                    <button id="playCardsButton">Play Cards</button>
                    <button id="burnTurnButton">Burn Turn</button>
                    <div><span>Score:?</span></div>
                    <div><span>Money:</span><span id="moneyCount"></span><span>/</span><span id="moneyTotal"></span></div>
                    <div><span>Workers:</span><span id="workerCount"></span><span>/</span><span id="workerTotal"></span></div>

                </div>
            </div>
        </div>

    </div>





</div>


<script>
    //TODO this needs to go somewhere else, part of hashchange
    var lastHash = '';


    jQuery('#connect').click(function(){
        StompService.connect();
    });

    jQuery('#disconnect').click(function(){
        StompService.disconnect();
    });


    jQuery('#registerUserSubmitButton').click(function(){
        var formString = jQuery('#registerUserForm').serialize();
        UserProxy.registerUser(formString);
    });

    jQuery('#loginSubmitButton').click(function(){
        var formString = jQuery('#loginUserForm').serialize();
        UserProxy.login(formString);

    });

    var startGameButton =
    jQuery('#startGameButton').click(function(){
        var emailToNotify = jQuery('#emailToNotifyInput').val();
        GameProxy.startGame(emailToNotify,"player");
    });

    var startGameNewPlayerButton =
    jQuery('#startGameNewPlayerButton').click(function(){
        var emailToNotify = jQuery('#newEmailToNotifyInput').val();
        GameProxy.startGame(emailToNotify,"newPlayer");
    });


    jQuery('#playCardsButton').click(function(){
        GameProxy.takeTurn();
    });
    
    jQuery('#burnTurnButton').click(function()
    {
    	GameProxy.burnTurn();
    });
    
    jQuery('#registerAsNewPlayerButton').click(function(){
        jQuery('#loginWrapper').hide();
        jQuery('#registerWrapper').fadeIn();
        window.location.hash = 'register';

    });




    //TODO this probably needs to be decoupled from here, and refactored with other things that determine the page layout
    /**
     * On hashchange Listener.  Watches the url hash for certain events
     * and allows the user to utilize the browser's 'back' button
     */
    jQuery(window).on('hashchange', function(e) {
        var hash = window.location.hash.substr(1);
        if(lastHash === 'game' && hash==='lobby'){
            jQuery('#gameStageWrapper').hide();
            jQuery('#lobbyWrapper').fadeIn();
        }else if(lastHash === 'lobby' && hash==='gamePanel'){
            jQuery('#lobbyWrapper').hide();

            //TODO may need to trigger display function for game
            jQuery('#gameStageWrapper').fadeIn();
        }



        lastHash = hash;
    });


    //for capturing new registrant links.  group1 is game id, group2 is encoded invitee email
    var registerRegex =/register(?:\?gameId=(\d+)&invitee=(.+))?/;
    //TODO this should be decoupled as well
    /**
     * This runs anything in it on page load (technically 'on page ready').
     */
    jQuery(function(){

        var isCookie = UserProxy.loadUserCookie();
        var hash = window.location.hash.substr(1);
        var registerMatch = hash.match(registerRegex);

        //Check if a cookie exists, load the lobby if it does.
        if(isCookie){
            var loginMessage = jQuery('.loginHide').fadeOut();
            StompService.connect(UserProxy.user.token);
            loginMessage.fadeIn().children().html('You are now connected to server as:<strong>' + UserProxy.user.email + "</strong> in <i>/queue/"+UserProxy.user.token+"</i>");
            jQuery('#lobbyWrapper').fadeIn();
            jQuery('#loginWrapper').hide();
            window.location.hash='lobby';
            jQuery('#logoutButton').show();

         //Check if someone came via a join link
        }else if(registerMatch && registerMatch[1] && registerMatch[2]){
            UserProxy.inviteeCreds.gameId = registerMatch[1];
            UserProxy.inviteeCreds.inviteeEmail = registerMatch[2];
            jQuery('#loginWrapper').hide();
            jQuery('#registerWrapper').fadeIn();
        }



    });





    jQuery('#logoutButton').click(function(){
        UserProxy.logout();
    });

    jQuery('#loginUserForm').find('input').keypress(function(e){
        if(e.which === 13){
            jQuery('#loginSubmitButton').click();
        }
    });



    jQuery('#backToLobbyButton').click(function(){
        window.location.hash = 'lobby';
        jQuery('gameStageWrapper').hide();
        jQuery('lobbyWrapper').fadeIn();
    });


    jQuery('#backToLoginButton').click(function(){
        window.location.hash = '';
        jQuery('registerWrapper').hide();
        jQuery('lobbyWrapper').fadeIn();
    });






</script>
</body>
</html>
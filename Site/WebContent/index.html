<!DOCTYPE html>
<html>
<head>
    <title>Race to the Bottom</title>
    <link rel="stylesheet" type="text/css" href="css/game.css">
    <link rel="stylesheet" type="text/css" href="css/objects.css">
    <link rel="stylesheet" type="text/css" href="css/animate.css">

    <!--1 Libraries-->
    <script src="js/lib/sockjs-0.3.4.js"></script>
    <script src="js/lib/stomp.js"></script>
    <script src="js/lib/jquery-2.1.1.min.js"></script>
    <!--2 Utilities-->
    <script type="text/javascript" src="js/stompService.js"></script>
    <!--3 Main Classes-->
    <script type="text/javascript" src="js/userProxy.js"></script>
    <script src="js/gameProxy.js"></script>
    <script src="js/debateGame.js"></script>


</head>
<body>
<noscript><h2 style="color: #ff0000">Seems your browser doesn't support Javascript! Websocket relies on Javascript being enabled. Please enable
    Javascript and reload this page!</h2></noscript>
<div id="mainContentWrapper" style="text-align:center">
    <button id="logoutButton" style="position:fixed;top:0;left:0;display:none;">Log Out</button>
    <div class="loginHide" style="display:none;"><span>&nbsp;</span></div>
    <div id="loginWrapper">
        <div id="loginTop" style="border: 1px solid black;background-color:cornflowerblue;">
            <form id="loginUserForm" >
                <h2>Login</h2>
                <label for="userEmailLogin">Email</label>
                <input id="userEmailLogin" name="email" type="text"   placeholder="email" />
                <label for="userPassLogin">Password</label>
                <input id="userPassLogin" name="password" type="password" placeholder="password" />

            </form>
            <div>
                <button id="loginSubmitButton" style="width: 100px;height: 30px;font-size: 15px;">Login</button>
            </div>
        </div>
        <div id="loginBottom">
            <button id="registerAsNewPlayerButton">Register as a new Player</button>

        </div>
    </div>


    <div id="registerWrapper" style="border: 1px solid black;display:none;background-color:cornsilk;">
        <button id="backToLoginButton">Back to Login Screen</button>
        <form id="registerUserForm" >
            <h2>Register User</h2>
            <label for="userEmail">Email</label>
            <input id="userEmail" name="email" type="text"   placeholder="email" />
            <label for="userPass">Password</label>
            <input id="userPass" name="password" type="password" placeholder="password" />
            <label for="userName">NickName</label>
            <input id="userName" name="name" type="text" placeholder="NickName" />
        </form>
        <button id="registerUserSubmitButton">Send Info</button>
    </div>




    <div id="lobbyWrapper" style="display:none;background-color:grey;border:1px solid black;">
        <div id="gamesInProgressWrapper">
        <h2>Games In Progress</h2>
        <table id="gamesInProgressTable" style="width:100%;background-color:white;border:1px solid black;">
        </table>
        </div>

        <div id="startAGameWrapper">
            <div id="startGamePanel" style="border: 1px solid black;background-color:indianred;">
                <div class="lobbyPanelContent">
                    <h2>Start a Game</h2>
                    <div>
                        <button>VS AI</button>
                    </div>
                    <div>
                        <button id="startGameButton">Invite a Player &gt;</button><input style="width:150px" id="emailToNotifyInput" name="emailToNotify" type="text" placeholder="Player email">
                    </div>
                    <div>
                        <button id="startGameNewPlayerButton">Invite a new Player &gt;</button><input id="newEmailToNotifyInput" name="newEmailToNotify" type="text" placeholder="New player email">
                    </div>

                </div>

            </div>
        </div>
        <div id="leaderBoardWrapper">
            <h2>LeaderBoard</h2>
            <table id = "leaderBoardTable" style="width:100%;background-color:white;border:1px solid black;">
            </table>
        </div>


    </div>



    <div id="gameStageWrapper" style="display:none;">
        <button id="backToLobbyButton">Back to Lobby</button>
        <div id="gameStageMain">
            <!---->
            <div id="waitingScreen">Waiting For Next Turn</div>

            <div id="districtWrapper">
                <!--Debate Game Overlay-->
                <div id="scrollWrapper" class="animated bounceInRight" style="display:none;">
                    <div id="scrollOverlay">
                        <h2>Debate!</h2>
                        <h3>Avoid what you can!</h3>
                        <h4>Click to start</h4>
                    </div>
                    <div id="scrollCell">
                        <div id="scrollStage">
                            <div id="debater"><img src="images/debater.png" style="width:50px;vertical-align:bottom;"></div>
                        </div>

                    </div>
                    <div id="scoreField">
                        0
                    </div>

                </div>
                <div id="districtStage" >
                    <!--Districts generated here-->
                </div>
            </div>

            <div id="bottomStage">
                <div id="cardStage">
                    <!--Cards generated here-->
                </div>
                <div id="widgetWrapper" style="width:70px">
                    <button id="playCardsButton" class="turnButton">Play Cards</button>
                    <button id="burnTurnButton" class="turnButton">Burn Turn</button>
                    <button id="surrenderButton" class="turnButton" style="background-color:red;">Concede Defeat</button>
                    <div><span>Money:</span><span id="moneyCount"></span><span>/</span><span id="moneyTotal"></span></div>
                    <div><span>Workers:</span><span id="workerCount"></span><span>/</span><span id="workerTotal"></span></div>

                </div>
            </div>
        </div>

    </div>

    <div id="adminPanelWrapper">

        <button id="adminButton" >Admin Panel</button>
        <div id="adminPanel" style="display:none;background-color: rgb(139, 147, 255);border: 1px solid grey;padding: 1em;box-shadow: 4px 4px 5px rgba(0, 0, 0, 0.5);">
           <h2>Admin Panel</h2>
            <fieldset>
                <legend>Remove User by Email</legend>
                <label>
                    User Email:
                    <input id="adminRemoveUserByEmailInput" type="text" />
                </label>
                <button id="adminRemoveUserByEmailButton">submit</button>
            </fieldset>
            <fieldset style="margin-top:1em;">
                <legend>Remove Game by ID</legend>
                <label>
                    Game ID:
                    <input id="adminRemoveGameByIdInput" type="text" />
                </label>
                <button id="adminRemoveGameByIdButton">submit</button>
            </fieldset>


        </div>
    </div>

</div>





<script>
    //TODO this needs to go somewhere else, part of hashchange
    var lastHash = '';


    jQuery('#connect').click(function(){
        StompService.connect();
    });

    jQuery('#disconnect').click(function(){
        StompService.disconnect();
    });


    jQuery('#registerUserSubmitButton').click(function(){
        var formString = jQuery('#registerUserForm').serialize();
        UserProxy.registerUser(formString);
    });

    jQuery('#loginSubmitButton').click(function(){
        var formString = jQuery('#loginUserForm').serialize();
        UserProxy.login(formString);

    });

    var startGameButton =
    jQuery('#startGameButton').click(function(){
        var emailToNotify = jQuery('#emailToNotifyInput').val();
        GameProxy.startGame(emailToNotify,"player");
    });

    var startGameNewPlayerButton =
    jQuery('#startGameNewPlayerButton').click(function(){
        var emailToNotify = jQuery('#newEmailToNotifyInput').val();
        GameProxy.startGame(emailToNotify,"newPlayer");
    });


    GameProxy.toggleButtonsHandlers(true);
    
    jQuery('#registerAsNewPlayerButton').click(function(){
        jQuery('#loginWrapper').hide();
        jQuery('#registerWrapper').fadeIn();
        window.location.hash = 'register';

    });




    //TODO this probably needs to be decoupled from here, and refactored with other things that determine the page layout
    /**
     * On hashchange Listener.  Watches the url hash for certain events
     * and allows the user to utilize the browser's 'back' button
     */
    jQuery(window).on('hashchange', function(e) {
        var hash = window.location.hash.substr(1);
        if(lastHash === 'game' && hash==='lobby'){
            jQuery('#gameStageWrapper').hide();
            jQuery('#lobbyWrapper').fadeIn();
        }else if(lastHash === 'lobby' && hash==='gamePanel'){
            jQuery('#lobbyWrapper').hide();

            //TODO may need to trigger display function for game
            jQuery('#gameStageWrapper').fadeIn();
        }



        lastHash = hash;
    });


    //for capturing new registrant links.  group1 is game id, group2 is encoded invitee email
    var registerRegex =/register(?:\?gameId=(\d+)&invitee=(.+))?/;
    //TODO this should be decoupled as well
    /**
     * This runs anything in it on page load (technically 'on page ready').
     */
    jQuery(function(){

        var isCookie = UserProxy.loadUserCookie();
        var hash = window.location.hash.substr(1);
        var registerMatch = hash.match(registerRegex);

        //Check if a cookie exists, attempt to login with it.
        if(isCookie){
            UserProxy.loginWithCookie();

         //Check if someone came via a join link
        }else if(registerMatch && registerMatch[1] && registerMatch[2]){
            UserProxy.inviteeCreds.gameId = registerMatch[1];
            UserProxy.inviteeCreds.inviteeEmail = registerMatch[2];
            jQuery('#loginWrapper').hide();
            jQuery('#registerWrapper').fadeIn();
        }



    });





    jQuery('#logoutButton').click(function(){
        UserProxy.logout();
    });

    jQuery('#loginUserForm').find('input').keypress(function(e){
        if(e.which === 13){
            jQuery('#loginSubmitButton').click();
        }
    });



    jQuery('#backToLobbyButton').click(function(){
        window.location.hash = 'lobby';
        jQuery('gameStageWrapper').hide();
        jQuery('lobbyWrapper').fadeIn();
    });


    jQuery('#backToLoginButton').click(function(){
        window.location.hash = '';
        jQuery('registerWrapper').hide();
        jQuery('lobbyWrapper').fadeIn();
    });

    jQuery('#adminButton').click(function(){
        jQuery('#adminPanel').toggle();
    });


    jQuery('#adminRemoveUserByEmailButton').click(function(){
        var value = jQuery('#adminRemoveUserByEmailInput').val();
        var user = UserProxy.user;
        StompService.sendMessage('admin_removeUserByEmail',{value:value,userEmail:user.email,userToken:user.token});
    });
    jQuery('#adminRemoveGameByIdButton').click(function(){
        var value = jQuery('#adminRemoveGameByIdInput').val();
        var user = UserProxy.user;
        StompService.sendMessage('admin_removeGameById',{value:value,userEmail:user.email,userToken:user.token});
    });


    //attempt to cleanly close websocket port when window closes
    window.onbeforeunload = function(e) {
        StompService.disconnect();
    };








</script>
</body>
</html>